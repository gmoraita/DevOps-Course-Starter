services:
- docker

branches:
  only:
    - master
    - module_9


before_script:
- echo "Test the TODO list"
- docker build --target testing-offline --tag todo-app:devops-course-starter_todoapp-test-offline .
- docker run --env-file .env.test todo-app:devops-course-starter_todoapp-test-offline
- docker build --target testing-online --tag todo-app:devops-course-starter_todoapp-test-online .
- docker run  -e DB_CONNECTION_STRING=$DB_CONNECTION_STRING -e DATA_COLLECTION=$DATA_COLLECTION todo-app:devops-course-starter_todoapp-test-online

      
script: 
- echo "Build the TODO list"
- docker build --target production --tag $DOCKER_USER/todo-app:$TRAVIS_COMMIT .

- echo "Push the TODO list to Docker Hub"
- echo $DOCKER_PWD | docker login --username $DOCKER_USER --password-stdin
- docker push $DOCKER_USER/todo-app:$TRAVIS_COMMIT

- echo "Push the TODO list to Heroku"
- docker pull $DOCKER_USER/todo-app:$TRAVIS_COMMIT
- docker tag $DOCKER_USER/todo-app:$TRAVIS_COMMIT registry.heroku.com/georgestodoapp/web
- heroku container:login
- docker push registry.heroku.com/georgestodoapp/web
- heroku container:release web -a georgestodoapp


env:
  global:
  - secure: "rkfYQl3c4KpiMarPBR3f9+sP/NUyBR+pV1XN4Go96fZi6SRv1mUvL9iL23IJA4Le9Z01kV4c/S17o8ling/5Qft4+D85OfauLeGWNlcRQlcanXsASQvyBk69GuQI3cgbBmzja7VOUznnQQtwhzZffFhXGBCMmozWsD9MMjMGps7e02ir43ewiWWhixbK9XY3/2ZOY3tR040vdZjprz1A1svNcx+OXZdOhhSfu2MuByenxpltV7kPVqknlUgXouRCBEoMHf0EXwFA+7mrvsVRhK7hXAoZZAoHTFufm5C/F/SOObLCQ9j5TY/NoEbFwz4utcgwoTIHteYmOsnZAiBb+zRrIxvmH/WgvRGLa6wy4QxdTehpLEwS/S2VLA9lCkBt18lvorMAGGx2FHje5VxhBr4iBCGm4ejyNZSSSSvWQC6EoUYZugq2sNQfHBlyO3M8CT2JmrBKpWjP4jaEoROLHm1ZC+zmX8/mtRjB8CnRTeaLz696H2fwJGKQ3+Hc/tOYoBtSrZqps76Dko7ou6WhmSdz01VJel2FM30lQhkqeqQvtwlU9o8S6PPL9UkRTb3sjpnhMSpoAoo+HqkEf4MNT1bS/QxnPfGfDDplKf0Es48ZvHhfX5IRmsNzDlrTt5+Hwvt1W2VRZcKc9Kq/rV9tcu3TFmdnfDYP32YSvslpPhI="