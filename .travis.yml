services:
- docker

branches:
  only:
    - master
    - module_9


before_script:
- echo "Test the TODO list"
- docker build --target testing-offline --tag todo-app:devops-course-starter_todoapp-test-offline .
- docker run --env-file .env.test todo-app:devops-course-starter_todoapp-test-offline
- docker build --target testing-online --tag todo-app:devops-course-starter_todoapp-test-online .
- echo $DB_CONNECTION_STRING
- echo $DATA_COLLECTION
- docker run  -e DB_CONNECTION_STRING=$DB_CONNECTION_STRING -e DATA_COLLECTION=$DATA_COLLECTION todo-app:devops-course-starter_todoapp-test-online

      
script: 
- echo "Build the TODO list"
- docker build --target production --tag $DOCKER_USER/todo-app:$TRAVIS_COMMIT .

- echo "Push the TODO list to Docker Hub"
- echo $DOCKER_PWD | docker login --username $DOCKER_USER --password-stdin
- docker push $DOCKER_USER/todo-app:$TRAVIS_COMMIT

- echo "Push the TODO list to Heroku"
- docker pull $DOCKER_USER/todo-app:$TRAVIS_COMMIT
- docker tag $DOCKER_USER/todo-app:$TRAVIS_COMMIT registry.heroku.com/georgestodoapp/web
- heroku container:login
- docker push registry.heroku.com/georgestodoapp/web
- heroku container:release web -a georgestodoapp


env:
  global:
    - secure: "A8kHp66nAAvW7yDhigX3UKW/cUtxdWCu+n1yAMYlaCMbiVw2csWc5uupkjQIE7hc+wcUrJBZ5agY8FkdH/MUp0a1LGtHNChfAqT0QzvvOpI949A1E22rqNi2V4zybBYD8ErSd6x7TgsKk3p1wc/qh68pY7aDPiJunh6kmxhVrbfg//C2QysGKYSv2JSC9gGGksePc/1bzo/dsn2MVjxmfR3lUPZt13Fb0vZypdT7JhEE9MzTEJ3/38aKqAsPJxp6Mq1REWpB9nfvjsvirfSHMLQqUhW8NQbk+yR+WV9O0X/HQjlhawW8IGRWkZFwIcozTjITP/5mPNx7iyt41ddTkUIWbwvLBRPbRLWq/iGi5nXVTqhjtLDK9zW/IKlZny8Sxdv3/oRGWPMcd47zp2Rnd9xAlM212PJ+djhMrts72qiOR8BJDpxR+zHM2FUOq7CPITzE/D7ZZyP8sNspQhjawEJL/PuI7Er9gd5rYsQI4SgPS4L+3L5ziwTtjhdVsAiSXfT337dsRGbf3R+oo6ATfOOaf8GALqDK3Obu3awZ5lVwbp47LTtqINcc/v/hDyhPYbEHbUL92YGC/8scUhFBDcKQgCdOK3yyH9rjsHZZ4929yApbPKOF77eEOHdqZ6+6LRYwS5ELtO7ZWHKyeqQ/qc16lYwdNkyCNOG7v9vHHd4="
    - secure: "TC4rXJgv55z7MPntcJPm+2/ZIoWfzT2Gg5K8xCLG+D3gXUXesjbyd7tRgcFzjNHRZOF4hti9enB9Hv68QHMBgCZrZSiTPFGKM2cgGnBIxgGq9mm0lqN4UI59J+iV6SGT4YN8i8oSoc+ktSl602oFTuYlYbPcJtJMsZcZwYekgN6a1Sj60kraDj23rU+DZYCVv8YACnuFMYPZWBkdrUWN1cpDGIvDFbrtXWHxMa126PRPi011qvn/k6BH4OcZz9OLFmH7oRNq/TjwoAZKgL3XSessyJrjBIgyWcwJHW91Hjb5BxDaMSvkaTh7s7th/8GSlNpZ81sxDzxGvbHK4R4FxqoSa8+Td0vVN+9md/gB30OXca6uQnaDZdQLUsQWZBT7lPCwfx1peF5vRx61VAsUqXj/puYS6GrNeUqwo4FnmYFMZdWvTIXmVoziDmet6IEp54RAuK0+ligunaAPmE4DSNel8odJgYfrmcTAYsjbcZ9ca8JquGlDX5CZPQi9GCUsnEiad+GuDuAQipieNpOXZm+KPktdSVQKtKVm4Css96swIvcmvdwUSx8Sh5N7BH95kSx/gspmOj7lcKwOa9kj5ygJmnY8ta4Iae4I8PeaZNaNJtFqGfwnER2y6dH3hXoC3H2gpMb497ie8ytsTkHyv5bOnC1m4eG8537oUP+iJQ0="
  